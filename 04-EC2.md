# 4. üíª EC2 (Elastic Compute Cloud)

**Amazon's virtual servers in the cloud**

![Security Groups](https://i.sstatic.net/9lBic.png)

![Security Group Rules](https://media.amazonwebservices.com/blog/2017/sg_rules_desc_3.png)

![EC2 Key Pairs](https://docs.aws.amazon.com/images/AWSEC2/latest/UserGuide/images/ec2-key-pair.png)

![EC2 Storage](https://labresources.whizlabs.com/516e758c4ef4090c845576d63361b214/copy_of_s3.png)

## What is EC2?

Amazon Elastic Compute Cloud provides scalable computing capacity in the AWS cloud. Launch virtual servers (instances) in minutes.

### Key Features
- ‚úÖ Complete control over instances
- ‚úÖ Pay-per-use pricing
- ‚úÖ Multiple instance types
- ‚úÖ Various operating systems
- ‚úÖ Auto scaling capabilities
- ‚úÖ Load balancing integration

## EC2 Instance Types

Instances are optimized for different workloads:

### General Purpose (T, M)
- **T3/T4**: Burstable, web servers, dev environments
- **M6**: Balanced compute, memory, network
- **Use Case**: Web apps, small databases

### Compute Optimized (C)
- **C6**: High-performance processors
- **Use Case**: Batch processing, gaming servers, ML inference

### Memory Optimized (R, X)
- **R6**: Large datasets in memory
- **X2**: Extreme memory needs
- **Use Case**: In-memory databases, big data analytics

### Storage Optimized (I, D)
- **I3**: High IOPS, NVMe SSD
- **D3**: Dense storage, data warehouses
- **Use Case**: NoSQL databases, data warehouses

### Accelerated Computing (P, G)
- **P4**: GPU instances for ML
- **G5**: Graphics-intensive applications
- **Use Case**: AI/ML training, 3D rendering

### Instance Naming Convention
**Example: t3.medium**
- **t** = Instance family (T for burstable)
- **3** = Generation
- **medium** = Size (nano, micro, small, medium, large, xlarge, 2xlarge...)

## EC2 Pricing Models

### 1. On-Demand
- Pay by hour or second
- No commitment
- Best for: Short-term, unpredictable workloads

### 2. Reserved Instances
- 1 or 3-year commitment
- Up to 75% discount
- Best for: Steady-state applications

### 3. Spot Instances
- Up to 90% discount
- Can be interrupted
- Best for: Fault-tolerant, flexible workloads

### 4. Savings Plans
- Flexible pricing model
- 1 or 3-year commitment
- Best for: Consistent usage

### 5. Dedicated Hosts
- Physical server dedication
- Compliance requirements
- Best for: Licensing, regulatory

## Security Groups

**Virtual firewalls** controlling inbound and outbound traffic

### Rules
- **Stateful**: Return traffic automatically allowed
- **Default**: All inbound denied, all outbound allowed
- **Multiple**: Attach multiple security groups per instance

### Example Rules

**Web Server Security Group:**
```
Inbound Rules:
- Type: HTTP, Protocol: TCP, Port: 80, Source: 0.0.0.0/0
- Type: HTTPS, Protocol: TCP, Port: 443, Source: 0.0.0.0/0
- Type: SSH, Protocol: TCP, Port: 22, Source: My IP

Outbound Rules:
- All traffic allowed (default)
```

### Best Practices
- ‚úÖ Least privilege principle
- ‚úÖ Specific CIDR blocks, avoid 0.0.0.0/0 for SSH
- ‚úÖ Separate security groups for different tiers
- ‚úÖ Use descriptive names and descriptions

## Key Pairs

**SSH keys** for secure instance access

### Components
- **Private Key**: Keep secret, used to connect (.pem file)
- **Public Key**: Stored on instance

### Creating Key Pair
1. EC2 Console ‚Üí Key Pairs ‚Üí Create
2. Download .pem file (only chance!)
3. Set permissions: \`chmod 400 mykey.pem\`
4. Connect: \`ssh -i mykey.pem ec2-user@<public-ip>\`

### Default Usernames
- Amazon Linux: \`ec2-user\`
- Ubuntu: \`ubuntu\`
- RHEL: \`ec2-user\` or \`root\`
- Windows: \`Administrator\`

## EBS (Elastic Block Store)

**Persistent block storage** for EC2 instances

### Volume Types

| Type | Name | IOPS | Throughput | Use Case |
|------|------|------|------------|----------|
| gp3 | General Purpose SSD | 3,000-16,000 | 125-1,000 MB/s | Boot volumes, apps |
| gp2 | General Purpose SSD | 3-16,000 | 250 MB/s | Cost-effective |
| io2 | Provisioned IOPS SSD | 64,000+ | 1,000+ MB/s | Databases |
| st1 | Throughput Optimized HDD | 500 | 500 MB/s | Big data |
| sc1 | Cold HDD | 250 | 250 MB/s | Infrequent access |

### Key Features
- ‚úÖ **Snapshots**: Backup to S3
- ‚úÖ **Encryption**: At-rest encryption
- ‚úÖ **Elastic**: Resize without downtime
- ‚úÖ **Multi-Attach**: io2 can attach to multiple instances

### EBS vs Instance Store

| Feature | EBS | Instance Store |
|---------|-----|----------------|
| **Persistence** | Yes | No (ephemeral) |
| **Backup** | Snapshots | None |
| **Performance** | Good | Excellent |
| **Use Case** | Databases | Temp data, cache |

## User Data & Metadata

### User Data
**Bootstrap script** that runs at instance launch

\`\`\`bash
#!/bin/bash
yum update -y
yum install -y httpd
systemctl start httpd
systemctl enable httpd
echo "<h1>Hello from \$(hostname)</h1>" > /var/www/html/index.html
\`\`\`

### Metadata
**Information about instance** (169.254.169.254)

\`\`\`bash
# Get instance ID
curl http://169.254.169.254/latest/meta-data/instance-id

# Get public IP
curl http://169.254.169.254/latest/meta-data/public-ipv4
\`\`\`

## EC2 Instance States

| State | Description | Billing |
|-------|-------------|---------|
| **Pending** | Starting | No |
| **Running** | Running | Yes |
| **Stopping** | Shutting down | No |
| **Stopped** | Stopped | EBS only |
| **Terminated** | Deleted | No |

## ‚úÖ Hands-on Lab: Launch Web Server

### Lab: Create and Configure EC2 Instance

**Step 1: Launch Instance**
1. Go to **EC2 Console** ‚Üí **Launch Instance**
2. Name: \`MyWebServer\`
3. Choose **Amazon Linux 2023**
4. Instance type: **t2.micro** (Free Tier)
5. Key pair: Create new \`my-webserver-key\`
6. Download \`.pem\` file

**Step 2: Configure Network Settings**
1. Create security group: \`web-server-sg\`
2. Add rules:
   - SSH (22) from My IP
   - HTTP (80) from Anywhere
   - HTTPS (443) from Anywhere
3. Configure storage: 8 GB gp3

**Step 3: Add User Data**
\`\`\`bash
#!/bin/bash
yum update -y
yum install -y httpd
systemctl start httpd
systemctl enable httpd
echo "<h1>Hello from \$(hostname -f)</h1>" > /var/www/html/index.html
\`\`\`

**Step 4: Launch Instance**
1. Click **Launch instance**
2. Wait for running state
3. Note public IP address

**Step 5: Test Connection**
\`\`\`bash
# SSH into instance
chmod 400 my-webserver-key.pem
ssh -i my-webserver-key.pem ec2-user@<PUBLIC_IP>

# Verify web server
curl localhost
\`\`\`

**Step 6: Access Website**
- Open browser: \`http://<PUBLIC_IP>\`
- Should see "Hello from..." message

### Lab: Create EBS Volume and Attach

1. **Create Volume**:
   - EC2 ‚Üí Elastic Block Store ‚Üí Volumes
   - Create Volume: 10 GB, gp3, same AZ as instance
   
2. **Attach to Instance**:
   - Select volume ‚Üí Actions ‚Üí Attach
   - Choose instance
   
3. **Format and Mount**:
\`\`\`bash
# View available disks
lsblk

# Format (if new)
sudo mkfs -t ext4 /dev/xvdf

# Create mount point
sudo mkdir /data

# Mount
sudo mount /dev/xvdf /data

# Auto-mount on reboot (add to /etc/fstab)
echo '/dev/xvdf /data ext4 defaults,nofail 0 2' | sudo tee -a /etc/fstab
\`\`\`

### Lab: Create AMI (Amazon Machine Image)

1. Select instance
2. Actions ‚Üí Image and templates ‚Üí Create image
3. Name: \`my-webserver-ami\`
4. Description: "Web server with Nginx installed"
5. Click **Create image**
6. Use this AMI to launch identical instances

## Common EC2 Issues & Solutions

| Issue | Solution |
|-------|----------|
| Can't SSH | Check security group, key permissions |
| No internet | Check route table, internet gateway |
| Slow performance | Wrong instance type, check CloudWatch |
| EBS full | Resize volume or add new one |
| Connection timeout | Security group blocking, NACL issues |

---

[‚Üê Previous: IAM](03-IAM.md) | [Back to Main Guide](README.md) | [Next: S3 ‚Üí](05-S3.md)
